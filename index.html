<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>PONTO PRO v8.0 - Com Foto</title>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
      /* CSS ORIGINAL PRESERVADO */
      :root {
        --primary: #0984e3;
        --bg-body: #f0f2f5;
        --bg-card: #ffffff;
        --text-main: #2d3436;
        --text-sub: #636e72;
        --success: #00b894;
        --warning: #fdcb6e;
        --danger: #d63031;
        --border: #dfe6e9;
        --nav-bg: #ffffff;
        --whatsapp: #25d366;
        --dodgeblue: #1e90ff;
      }
      body.dark-mode {
        --bg-body: #18191a;
        --bg-card: #242526;
        --text-main: #e4e6eb;
        --text-sub: #b0b3b8;
        --border: #3a3b3c;
        --nav-bg: #242526;
      }
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        font-family: "Segoe UI", sans-serif;
      }
      body {
        background-color: var(--bg-body);
        color: var(--text-main);
        margin: 0;
        padding-bottom: 100px;
        transition: 0.3s;
      }

      .app-header {
        position: sticky;
        top: 0;
        background: var(--bg-card);
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        z-index: 1000;
      }
      .container {
        padding: 15px;
        max-width: 800px;
        margin: 0 auto;
      }

      /* ESTILOS DA FOTO ATUALIZADOS */
      .photo-captured-wrap {
        width: 65px;
        height: 65px;
        border-radius: 50%;
        overflow: hidden;
        border: 2px solid var(--primary);
        background: #eee;
        flex-shrink: 0;
      }
      .photo-captured-wrap img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .emp-card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
      }
      .emp-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--border);
      }

      /* RESTANTE DO CSS ORIGINAL PRESERVADO */
      .dash-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-bottom: 15px;
      }
      .dash-card {
        background: var(--bg-card);
        padding: 12px 5px;
        border-radius: 12px;
        text-align: center;
        font-size: 10px;
        border-bottom: 3px solid var(--border);
      }
      .dash-card span {
        display: block;
        font-size: 18px;
        font-weight: bold;
      }
      .search-input,
      .select-input {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--bg-card);
        color: var(--text-main);
        margin-bottom: 10px;
        outline: none;
      }
      .emp-card {
        background: var(--bg-card);
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 12px;
        border: 1px solid var(--border);
        transition: 0.3s;
        cursor: pointer;
      }
      .emp-card.open {
        border-color: var(--primary);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .status-pill {
        font-size: 10px;
        padding: 4px 8px;
        border-radius: 6px;
        font-weight: bold;
        color: white;
        float: right;
      }
      .time-tag {
        background: var(--bg-body);
        padding: 4px 8px;
        border-radius: 5px;
        font-size: 11px;
        font-weight: bold;
        border: 1px solid var(--border);
        margin-right: 4px;
        margin-bottom: 4px;
        display: inline-block;
      }
      .smart-details {
        max-height: 0;
        overflow: hidden;
        transition: 0.3s ease-out;
        opacity: 0;
      }
      .emp-card.open .smart-details {
        max-height: 1000px;
        opacity: 1;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--border);
      }
      .btn {
        padding: 12px;
        border-radius: 10px;
        border: none;
        font-weight: bold;
        cursor: pointer;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 10px;
        color: white;
        font-size: 13px;
      }
      .btn-sm {
        padding: 8px;
        font-size: 11px;
        margin-top: 5px;
      }
      .section-divider {
        margin: 25px 0 15px;
        border-top: 2px solid var(--border);
        padding-top: 15px;
      }
      .log-container {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px;
        max-height: 200px;
        overflow-y: auto;
        font-size: 11px;
      }
      .log-item {
        padding: 5px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
      }
      .bottom-nav {
        position: fixed;
        bottom: 0;
        width: 100%;
        height: 70px;
        background: var(--nav-bg);
        display: flex;
        justify-content: space-around;
        align-items: center;
        border-top: 1px solid var(--border);
        z-index: 1100;
      }
      .nav-btn {
        background: none;
        border: none;
        color: var(--text-sub);
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 9px;
      }
      .nav-btn.active {
        color: var(--primary);
      }
      .nav-btn-main {
        width: 50px;
        height: 50px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        margin-top: -30px;
        border: none;
        font-size: 24px;
        box-shadow: 0 4px 12px rgba(9, 132, 227, 0.4);
      }
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        padding: 20px;
      }
      .modal-box {
        background: var(--bg-card);
        width: 100%;
        max-width: 400px;
        padding: 25px;
        border-radius: 20px;
        max-height: 90vh;
        overflow-y: auto;
      }
      .tab-pane {
        display: none;
      }
      .tab-pane.active {
        display: block;
      }
      .edit-ponto-item {
        display: flex;
        gap: 5px;
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <header class="app-header">
      <div>
        <h1 style="margin: 0; font-size: 18px">
          PONTO PRO <small style="font-size: 10px; opacity: 0.5">v8.0</small>
        </h1>
        <input
          type="date"
          id="inputDataFiltro"
          onchange="mudarData()"
          style="
            border: none;
            background: none;
            font-size: 12px;
            color: var(--primary);
            font-weight: bold;
          "
        />
      </div>
      <button
        onclick="document.body.classList.toggle('dark-mode')"
        style="background: none; border: none; font-size: 20px"
      >
        üåì
      </button>
    </header>

    <div class="container">
      <main id="tab-registros" class="tab-pane active">
        <div class="dash-grid">
          <div class="dash-card"><span id="dashTotal">0</span>Total</div>
          <div class="dash-card" style="border-color: var(--success)">
            <span id="dashOk">0</span>OK
          </div>
          <div class="dash-card" style="border-color: var(--warning)">
            <span id="dashPen">0</span>P√°tio
          </div>
          <div class="dash-card"><span id="dashVazio">0</span>Faltas</div>
        </div>
        <input
          type="text"
          id="searchInput"
          class="search-input"
          placeholder="üîç Buscar colaborador ou placa..."
          oninput="renderizar()"
        />
        <div id="cardsContainer"></div>
      </main>

      <section id="tab-local" class="tab-pane">
        <h3>üìç No P√°tio agora</h3>
        <div id="painelLocal"></div>
      </section>

      <section id="tab-dia" class="tab-pane">
        <h3>üìñ Registro do Dia (Completo)</h3>
        <div
          style="
            width: 100%;
            overflow-x: auto;
            background: var(--bg-card);
            border-radius: 10px;
            border: 1px solid var(--border);
            margin-bottom: 10px;
          "
        >
          <table
            style="
              width: 100%;
              border-collapse: collapse;
              font-size: 12px;
              min-width: 600px;
            "
          >
            <thead>
              <tr style="background: var(--bg-body); text-align: left">
                <th style="padding: 10px">Nome</th>
                <th>Setor</th>
                <th>Placa</th>
                <th style="color: var(--primary)">Movimenta√ß√µes</th>
                <th style="color: var(--success)">Total</th>
              </tr>
            </thead>
            <tbody id="listaRegistroDia"></tbody>
          </table>
        </div>
        <button class="btn" style="background: #e74c3c" onclick="gerarPDF()">
          üìÑ PDF Relat√≥rio do Dia
        </button>
        <div class="section-divider"></div>
        <h3>üë§ Relat√≥rio Individual (Hist√≥rico)</h3>
        <select id="selectFuncionarioIndividual" class="select-input">
          <option value="">Selecione o funcion√°rio...</option>
        </select>
        <button
          class="btn"
          style="background: #6c5ce7"
          onclick="gerarPDFIndividual()"
        >
          üìë Gerar Hist√≥rico Individual
        </button>
      </section>

      <section id="tab-tools" class="tab-pane">
        <h3>‚öôÔ∏è Administrativo</h3>
        <button
          class="btn"
          style="background: #6c5ce7"
          onclick="validarGestor(alterarSenhaAdmin)"
        >
          üîë Alterar Senha Admin
        </button>
        <button
          class="btn"
          style="background: #27ae60"
          onclick="exportarCSVExcel()"
        >
          üìä Exportar para Excel (.csv)
        </button>
        <button
          class="btn"
          style="background: #0984e3"
          onclick="exportarJSONBackup()"
        >
          üì§ Exportar Backup (.json)
        </button>
        <button
          class="btn"
          style="background: #e67e22"
          onclick="validarGestor(() => document.getElementById('fileImport').click())"
        >
          üì• Importar Backup (.json)
        </button>
        <input
          type="file"
          id="fileImport"
          style="display: none"
          accept=".json"
          onchange="importarJSON(event)"
        />
        <div class="section-divider"></div>
        <h3>üìë Log de Edi√ß√µes Recentes</h3>
        <div id="logEdicoesContainer" class="log-container">
          <p style="text-align: center; color: var(--text-sub)">
            Nenhuma edi√ß√£o registrada.
          </p>
        </div>
      </section>
    </div>

    <nav class="bottom-nav">
      <button class="nav-btn active" onclick="switchTab('tab-registros', this)">
        üìã Ponto
      </button>
      <button class="nav-btn" onclick="switchTab('tab-local', this)">
        üìç Local
      </button>
      <button class="nav-btn-main" onclick="abrirModalCadastro()">Ôºã</button>
      <button class="nav-btn" onclick="switchTab('tab-dia', this)">
        üìñ Registro
      </button>
      <button class="nav-btn" onclick="switchTab('tab-tools', this)">
        ‚öôÔ∏è Mais
      </button>
    </nav>

    <div id="modalCadastro" class="modal">
      <div class="modal-box">
        <h3>Dados do Colaborador</h3>

        <div
          style="
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 15px;
          "
        >
          <div class="photo-captured-wrap">
            <img
              id="prevFoto"
              src="https://cdn-icons-png.flaticon.com/512/149/149071.png"
            />
          </div>
          <button
            class="btn btn-sm"
            style="background: var(--primary); margin: 0; flex: 1"
            onclick="document.getElementById('inputFoto').click()"
          >
            üì∏ Selecionar Foto
          </button>
          <input
            type="file"
            id="inputFoto"
            accept="image/*"
            style="display: none"
            onchange="carregarFotoDoAparelho(this)"
          />
        </div>

        <input type="hidden" id="formId" />
        <input
          type="text"
          id="formNome"
          class="search-input"
          placeholder="Nome Completo"
        />
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px">
          <input
            type="text"
            id="formPlaca"
            class="search-input"
            placeholder="Placa"
            oninput="mascaraPlaca(this)"
            maxlength="8"
          />
          <input
            type="text"
            id="formTelefone"
            class="search-input"
            placeholder="WhatsApp"
            oninput="mascaraTel(this)"
            maxlength="15"
          />
        </div>
        <input
          type="text"
          id="formFuncao"
          class="search-input"
          placeholder="Setor"
        />
        <input
          type="text"
          id="formOcorrencia"
          class="search-input"
          placeholder="Ocorr√™ncia"
        />

        <div
          id="secaoEdicaoPonto"
          style="
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed var(--border);
          "
        >
          <div id="listaHorariosEdit"></div>
          <button
            class="btn btn-sm"
            style="background: var(--text-sub)"
            onclick="adicionarHorarioManual()"
          >
            + Add Hor√°rio
          </button>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px">
          <button
            class="btn"
            style="background: #95a5a6"
            onclick="fecharModais()"
          >
            Sair
          </button>
          <button
            class="btn"
            style="background: var(--primary)"
            onclick="salvarAlteracoesCompletas()"
          >
            Salvar
          </button>
        </div>
      </div>
    </div>

    <script>
      /* CONFIGURA√á√ÉO FIREBASE MANTIDA */
      const firebaseConfig = {
        apiKey: "AIzaSyBfcH5K-9sz7WQIZrt7Cb4U39r7vuU6E7Q",
        authDomain: "espelhodepontoetecvilaformosa.firebaseapp.com",
        databaseURL:
          "https://espelhodepontoetecvilaformosa-default-rtdb.firebaseio.com",
        projectId: "espelhodepontoetecvilaformosa",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      let funcionarios = [];
      let dataISO = new Date().toISOString().slice(0, 10);
      let horariosTemporarios = [];

      db.ref("funcionarios").on("value", (s) => {
        funcionarios = s.val() ? Object.values(s.val()) : [];
        renderizar();
        renderizarLocal();
        renderizarRegistroDia();
        atualizarSelectIndividual();
        atualizarPainelLog();
      });

      document.getElementById("inputDataFiltro").value = dataISO;

      /* NOVA FUN√á√ÉO DE IMAGEM DO APARELHO */
      function carregarFotoDoAparelho(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            document.getElementById("prevFoto").src = e.target.result;
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      /* TODAS AS DEMAIS FUN√á√ïES PRESERVADAS INTEGRALMENTE */
      function calcularTempoPermanencia(marcacoes) {
        if (marcacoes.length < 2) return "---";
        let totalMinutos = 0;
        for (let i = 0; i < marcacoes.length; i += 2) {
          if (marcacoes[i + 1]) {
            const entrada = new Date(`2000-01-01T${marcacoes[i]}`);
            const saida = new Date(`2000-01-01T${marcacoes[i + 1]}`);
            totalMinutos += (saida - entrada) / 60000;
          }
        }
        const h = Math.floor(totalMinutos / 60);
        const m = Math.floor(totalMinutos % 60);
        return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;
      }

      function renderizar() {
        const container = document.getElementById("cardsContainer");
        const busca = document
          .getElementById("searchInput")
          .value.toUpperCase();
        container.innerHTML = "";
        let ok = 0,
          pen = 0,
          vaz = 0;

        funcionarios
          .filter((f) =>
            (f.nome + (f.placa || "")).toUpperCase().includes(busca)
          )
          .forEach((f) => {
            const h = f.historico?.[dataISO]?.marcacoes || [];
            const status =
              h.length === 0
                ? "VAZIO"
                : h.length % 2 !== 0
                ? "PENDENTE"
                : "FECHADO";
            if (status === "FECHADO") ok++;
            else if (status === "PENDENTE") pen++;
            else vaz++;

            const card = document.createElement("div");
            card.className = "emp-card";
            card.onclick = (e) => {
              if (!e.target.closest("button")) card.classList.toggle("open");
            };

            const fotoUrl =
              f.foto || "https://cdn-icons-png.flaticon.com/512/149/149071.png";

            card.innerHTML = `
                <span class="status-pill" style="background:${
                  status === "FECHADO"
                    ? "var(--success)"
                    : status === "PENDENTE"
                    ? "var(--warning)"
                    : "var(--text-sub)"
                }">${status}</span>
                <div class="emp-card-header">
                    <img src="${fotoUrl}" class="emp-avatar">
                    <div>
                        <b>${f.nome}</b><br>
                        <small>${f.placa || "---"} | ${
              f.funcao || "---"
            }</small>
                    </div>
                </div>
                <div style="margin-top:8px">${
                  h.map((t) => `<span class="time-tag">${t}</span>`).join("") ||
                  "---"
                }</div>
                <div class="smart-details">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px">
                        <button class="btn btn-sm" style="background:var(--whatsapp)" onclick="zapPrivado('${
                          f.id
                        }')">üì± Whats</button>
                        <button class="btn btn-sm" style="background:var(--danger)" onclick="zapGrupo('${
                          f.id
                        }')">üì¢ Grupo</button>
                        <button class="btn btn-sm" style="background:var(--primary)" onclick="validarGestor(() => abrirEdicao('${
                          f.id
                        }'))">‚öôÔ∏è Dados</button>
                        <button class="btn btn-sm" style="background:#000" onclick="validarGestor(() => excluirCadastro('${
                          f.id
                        }', '${f.nome}'))">üóëÔ∏è Excluir</button>
                    </div>
                </div>
                <button class="btn" style="background:var(--primary); margin-top:10px" onclick="baterPonto('${
                  f.id
                }')">REGISTRAR PONTO</button>
            `;
            container.appendChild(card);
          });
        document.getElementById("dashTotal").innerText = funcionarios.length;
        document.getElementById("dashOk").innerText = ok;
        document.getElementById("dashPen").innerText = pen;
        document.getElementById("dashVazio").innerText = vaz;
      }

      function salvarAlteracoesCompletas() {
        const id =
          document.getElementById("formId").value || Date.now().toString();
        const f = funcionarios.find((x) => x.id === id) || {
          id,
          historico: {},
        };
        const agoraLog = new Date().toLocaleString("pt-BR");

        const obj = {
          ...f,
          nome: document.getElementById("formNome").value.toUpperCase(),
          placa: document.getElementById("formPlaca").value.toUpperCase(),
          telefone: document.getElementById("formTelefone").value,
          funcao: document.getElementById("formFuncao").value.toUpperCase(),
          ocorrencia: document
            .getElementById("formOcorrencia")
            .value.toUpperCase(),
          foto: document.getElementById("prevFoto").src,
          ultimaEdicao: agoraLog,
        };
        if (!obj.historico) obj.historico = {};
        if (!obj.historico[dataISO]) obj.historico[dataISO] = { marcacoes: [] };
        obj.historico[dataISO].marcacoes = horariosTemporarios.sort();
        db.ref("funcionarios/" + id)
          .set(obj)
          .then(() => fecharModais());
      }

      function abrirEdicao(id) {
        const f = funcionarios.find((x) => x.id === id);
        document.getElementById("formId").value = f.id;
        document.getElementById("formNome").value = f.nome;
        document.getElementById("formPlaca").value = f.placa || "";
        document.getElementById("formTelefone").value = f.telefone || "";
        document.getElementById("formFuncao").value = f.funcao || "";
        document.getElementById("formOcorrencia").value = f.ocorrencia || "";
        document.getElementById("prevFoto").src =
          f.foto || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
        horariosTemporarios = [...(f.historico?.[dataISO]?.marcacoes || [])];
        renderizarHorariosEdicao();
        document.getElementById("modalCadastro").style.display = "flex";
      }

      function baterPonto(id) {
        const agora = new Date().toLocaleTimeString("pt-BR");
        db.ref(`funcionarios/${id}/historico/${dataISO}/marcacoes`)
          .get()
          .then((s) => {
            let m = s.val() || [];
            m.push(agora);
            db.ref(`funcionarios/${id}/historico/${dataISO}/marcacoes`).set(m);
          });
      }

      function fecharModais() {
        document
          .querySelectorAll(".modal")
          .forEach((m) => (m.style.display = "none"));
      }

      function atualizarPainelLog() {
        const container = document.getElementById("logEdicoesContainer");
        const edits = funcionarios
          .filter((f) => f.ultimaEdicao)
          .sort((a, b) => b.ultimaEdicao.localeCompare(a.ultimaEdicao));
        if (edits.length === 0) return;
        container.innerHTML = edits
          .map(
            (f) =>
              `<div class="log-item"><span><b>${f.nome}</b></span><span style="color:var(--text-sub)">${f.ultimaEdicao}</span></div>`
          )
          .join("");
      }

      function exportarJSONBackup() {
        const dataStr = JSON.stringify(funcionarios, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `backup_ponto_${new Date().getTime()}.json`;
        link.click();
      }

      function exportarCSVExcel() {
        let csv = "\uFEFFNome;Placa;Setor;Registros;Total Horas\n";
        funcionarios.forEach((f) => {
          const h = f.historico?.[dataISO]?.marcacoes || [];
          const total = calcularTempoPermanencia(h);
          csv += `${f.nome};${f.placa || ""};${f.funcao || ""};${h.join(
            "|"
          )};${total}\n`;
        });
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `ponto_detalhado_${dataISO}.csv`;
        link.click();
      }

      function excluirCadastro(id, nome) {
        if (confirm(`Excluir ${nome}?`)) db.ref(`funcionarios/${id}`).remove();
      }

      function zapPrivado(id) {
        const f = funcionarios.find((x) => x.id === id);
        if (!f.telefone) return alert("Sem n√∫mero!");
        window.open(
          `https://api.whatsapp.com/send?phone=55${f.telefone.replace(
            /\D/g,
            ""
          )}&text=Ol√° ${f.nome}, aviso: ${f.ocorrencia || "Ponto ok"}`,
          "_blank"
        );
      }

      function zapGrupo(id) {
        const f = funcionarios.find((x) => x.id === id);
        window.open(
          `https://api.whatsapp.com/send?text=${encodeURIComponent(
            "‚ö†Ô∏è AVISO: " +
              f.nome +
              " (" +
              (f.placa || "") +
              ") - " +
              (f.ocorrencia || "Ponto") +
              "\n\n" +
              " | SISTEMA DESENVOLVIDO POR RDG DEVELOPER |"
          )}`,
          "_blank"
        );
      }

      async function gerarPDFIndividual() {
        const id = document.getElementById("selectFuncionarioIndividual").value;
        if (!id) return alert("Selecione!");
        const f = funcionarios.find((x) => x.id === id);
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text(`Hist√≥rico: ${f.nome}`, 14, 15);
        const rows = [];
        if (f.historico)
          Object.keys(f.historico)
            .sort()
            .forEach((d) => {
              const h = f.historico[d].marcacoes || [];
              if (h.length > 0)
                rows.push([d, h.join(" | "), calcularTempoPermanencia(h)]);
            });
        doc.autoTable({
          head: [["Data", "Movimenta√ß√µes", "Total Perman√™ncia"]],
          body: rows,
          startY: 25,
        });
        doc.save(`ponto_${f.nome}.pdf`);
      }

      function renderizarLocal() {
        const p = document.getElementById("painelLocal");
        p.innerHTML = "";
        funcionarios.forEach((f) => {
          const h = f.historico?.[dataISO]?.marcacoes || [];
          if (h.length % 2 !== 0)
            p.innerHTML += `<div style="background:var(--dodgeblue); color:white; padding:12px; border-radius:10px; margin-bottom:5px"><b>${
              f.nome
            }</b> - Entrada: ${h.slice(-1)}</div>`;
        });
      }

      function renderizarRegistroDia() {
        const l = document.getElementById("listaRegistroDia");
        l.innerHTML = "";
        funcionarios
          .filter((f) => f.historico?.[dataISO]?.marcacoes?.length > 0)
          .sort((a, b) =>
            a.historico[dataISO].marcacoes[0].localeCompare(
              b.historico[dataISO].marcacoes[0]
            )
          )
          .forEach((f) => {
            const h = f.historico[dataISO].marcacoes;
            const tags = h
              .map((time, index) => {
                const cor =
                  index % 2 === 0 ? "var(--success)" : "var(--danger)";
                return `<span class="time-tag" style="border-left: 3px solid ${cor}">${time}</span>`;
              })
              .join("");
            const total = calcularTempoPermanencia(h);
            l.innerHTML += `<tr><td style="padding:10px"><b>${
              f.nome
            }</b></td><td>${f.funcao || "---"}</td><td>${
              f.placa || ""
            }</td><td>${tags}</td><td style="font-weight:bold; color:var(--primary)">${total}</td></tr>`;
          });
      }

      async function gerarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text(`Relat√≥rio Geral - ${dataISO}`, 14, 15);
        const rows = funcionarios
          .filter((f) => f.historico?.[dataISO]?.marcacoes?.length > 0)
          .map((f) => [
            f.nome,
            f.funcao || "",
            f.placa || "",
            f.historico[dataISO].marcacoes.join(" | "),
            calcularTempoPermanencia(f.historico[dataISO].marcacoes),
          ]);
        doc.autoTable({
          head: [["Nome", "Setor", "Placa", "Registros", "Total"]],
          body: rows,
          startY: 25,
          styles: { fontSize: 7 },
        });
        doc.save(`ponto_geral_${dataISO}.pdf`);
      }

      function renderizarHorariosEdicao() {
        const c = document.getElementById("listaHorariosEdit");
        c.innerHTML = "";
        horariosTemporarios.forEach((h, idx) => {
          c.innerHTML += `<div class="edit-ponto-item"><input type="time" step="1" value="${h}" onchange="horariosTemporarios[${idx}]=this.value"> <button onclick="horariosTemporarios.splice(${idx},1);renderizarHorariosEdicao()">üóëÔ∏è</button></div>`;
        });
      }

      function atualizarSelectIndividual() {
        const s = document.getElementById("selectFuncionarioIndividual");
        s.innerHTML = '<option value="">Selecione...</option>';
        funcionarios
          .sort((a, b) => a.nome.localeCompare(b.nome))
          .forEach((f) => {
            s.innerHTML += `<option value="${f.id}">${f.nome}</option>`;
          });
      }

      function mascaraPlaca(i) {
        let v = i.value.toUpperCase().replace(/[^A-Z0-9]/g, "");
        if (v.length > 3) v = v.substring(0, 3) + "-" + v.substring(3, 7);
        i.value = v;
      }

      function mascaraTel(i) {
        let v = i.value.replace(/\D/g, "");
        v = v
          .replace(/^(\d{2})(\d)/g, "($1) $2")
          .replace(/(\d)(\d{4})$/, "$1-$2");
        i.value = v;
      }

      function switchTab(id, btn) {
        document
          .querySelectorAll(".tab-pane, .nav-btn")
          .forEach((el) => el.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        btn.classList.add("active");
      }

      function abrirModalCadastro() {
        document.getElementById("formId").value = "";
        document
          .querySelectorAll("#modalCadastro input")
          .forEach((i) => (i.value = ""));
        document.getElementById("prevFoto").src =
          "https://cdn-icons-png.flaticon.com/512/149/149071.png";
        horariosTemporarios = [];
        renderizarHorariosEdicao();
        document.getElementById("modalCadastro").style.display = "flex";
      }

      function mudarData() {
        dataISO = document.getElementById("inputDataFiltro").value;
        renderizar();
        renderizarLocal();
        renderizarRegistroDia();
      }

      function validarGestor(cb) {
        db.ref("config/admin_pass").once("value", (s) => {
          const p = s.val() || "1234";
          const t = prompt("Senha:");
          if (t === p) cb();
          else alert("Incorreta!");
        });
      }

      function adicionarHorarioManual() {
        horariosTemporarios.push("12:00:00");
        renderizarHorariosEdicao();
      }

      function alterarSenhaAdmin() {
        const n = prompt("Nova senha:");
        if (n) db.ref("config/admin_pass").set(n);
      }

      function importarJSON(e) {
        const reader = new FileReader();
        reader.onload = (f) => {
          try {
            const data = JSON.parse(f.target.result);
            db.ref("funcionarios")
              .set(data)
              .then(() => alert("Backup restaurado!"));
          } catch (e) {
            alert("Erro no arquivo!");
          }
        };
        reader.readAsText(e.target.files[0]);
      }
    </script>
  </body>
</html>
<!--Rodrigo Developer - parte 03-->
