<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>PONTO PRO v5.1</title>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
      :root {
        --primary: #0984e3;
        --bg-body: #f0f2f5;
        --bg-card: #ffffff;
        --text-main: #2d3436;
        --text-sub: #636e72;
        --success: #00b894;
        --warning: #fdcb6e;
        --danger: #d63031;
        --border: #dfe6e9;
        --nav-bg: #ffffff;
        --local-bg: #e8f8f5;
        --alert-color: #e67e22;
        --visitor-blue: #3498db;
        --whatsapp: #25d366;
      }
      body.dark-mode {
        --bg-body: #18191a;
        --bg-card: #242526;
        --text-main: #e4e6eb;
        --text-sub: #b0b3b8;
        --border: #3a3b3c;
        --nav-bg: #242526;
      }
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        font-family: "Segoe UI", Roboto, sans-serif;
      }
      body {
        background-color: var(--bg-body);
        color: var(--text-main);
        margin: 0;
        padding-bottom: 100px;
        transition: background 0.3s;
      }

      /* Notifica√ß√£o Toast */
      #toast {
        visibility: hidden;
        min-width: 280px;
        background-color: #2d3436;
        color: #fff;
        text-align: center;
        border-radius: 12px;
        padding: 16px;
        position: fixed;
        z-index: 10000;
        left: 50%;
        bottom: 80px;
        transform: translateX(-50%);
        font-weight: 500;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
      }
      #toast.show {
        visibility: visible;
        animation: fadein 0.5s, fadeout 0.5s 2.5s;
      }
      @keyframes fadein {
        from {
          bottom: 0;
          opacity: 0;
        }
        to {
          bottom: 80px;
          opacity: 1;
        }
      }
      @keyframes fadeout {
        from {
          bottom: 80px;
          opacity: 1;
        }
        to {
          bottom: 0;
          opacity: 0;
        }
      }

      .app-header {
        position: sticky;
        top: 0;
        background: var(--bg-card);
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        z-index: 1000;
      }
      .container {
        padding: 15px;
        max-width: 800px;
        margin: 0 auto;
      }
      .dash-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-bottom: 15px;
      }
      .dash-card {
        background: var(--bg-card);
        padding: 12px 5px;
        border-radius: 12px;
        text-align: center;
        font-size: 10px;
        border-bottom: 3px solid var(--border);
        cursor: pointer;
        transition: transform 0.2s;
      }
      .dash-card:active {
        transform: scale(0.95);
      }
      .dash-card.active-filter {
        background: var(--border);
        border-bottom-width: 5px;
      }
      .dash-card span {
        display: block;
        font-size: 18px;
        font-weight: bold;
      }
      .search-input {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--bg-card);
        color: var(--text-main);
        margin-bottom: 15px;
      }

      .emp-card {
        background: var(--bg-card);
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 12px;
        border: 1px solid var(--border);
        position: relative;
        transition: 0.3s;
      }
      .emp-card.has-alert {
        border: 2px solid var(--alert-color);
        animation: pulseAlert 2s infinite;
      }
      @keyframes pulseAlert {
        0% {
          border-color: var(--alert-color);
        }
        50% {
          border-color: transparent;
        }
        100% {
          border-color: var(--alert-color);
        }
      }

      .badge-vinculo {
        font-size: 9px;
        padding: 2px 6px;
        border-radius: 4px;
        color: white;
        font-weight: bold;
        text-transform: uppercase;
        margin-bottom: 5px;
        display: inline-block;
      }
      .status-pill {
        font-size: 10px;
        padding: 4px 8px;
        border-radius: 6px;
        font-weight: 900;
        color: white;
      }
      .time-tag {
        background: var(--bg-body);
        padding: 4px 8px;
        border-radius: 5px;
        font-size: 11px;
        font-weight: bold;
        border: 1px solid var(--border);
      }

      .btn-whatsapp {
        background: var(--whatsapp);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        text-decoration: none;
        position: relative;
        z-index: 20;
      }
      .btn-group-alert {
        background: #d63031;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        position: relative;
        z-index: 20;
      }

      .smart-details {
        max-height: 0;
        overflow: hidden;
        transition: 0.3s ease-out;
        opacity: 0;
        background: var(--bg-body);
        border-radius: 8px;
      }
      .emp-card.open .smart-details {
        max-height: 1200px;
        opacity: 1;
        margin-top: 10px;
        padding: 10px;
      }

      .btn {
        flex: 1;
        padding: 10px;
        border-radius: 8px;
        border: none;
        font-weight: bold;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        position: relative;
        z-index: 10;
      }
      .tab-pane {
        display: none;
      }
      .tab-pane.active {
        display: block;
      }

      .bottom-nav {
        position: fixed;
        bottom: 0;
        width: 100%;
        height: 70px;
        background: var(--nav-bg);
        display: flex;
        justify-content: space-around;
        align-items: center;
        border-top: 1px solid var(--border);
        z-index: 1100;
      }
      .nav-btn {
        background: none;
        border: none;
        color: var(--text-sub);
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 10px;
      }
      .nav-btn.active {
        color: var(--primary);
      }
      .nav-btn-main {
        width: 50px;
        height: 50px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        margin-top: -30px;
        border: none;
        font-size: 24px;
        box-shadow: 0 4px 10px rgba(9, 132, 227, 0.3);
      }

      #modalCadastro,
      #pontoEditModal,
      #modalSenha {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        padding: 20px;
      }
      .modal-box {
        background: var(--bg-card);
        width: 100%;
        max-width: 400px;
        padding: 25px;
        border-radius: 20px;
        overflow-y: auto;
        max-height: 90vh;
      }

      .local-card {
        background: var(--local-bg);
        border: 2px solid var(--success);
        padding: 12px;
        border-radius: 12px;
        text-align: center;
      }
      .local-timer {
        font-family: monospace;
        background: var(--success);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        margin-top: 8px;
        display: inline-block;
      }
      .log-item {
        background: var(--bg-body);
        padding: 8px;
        border-radius: 8px;
        margin-bottom: 5px;
        font-size: 10px;
        border-left: 3px solid var(--primary);
      }
    </style>
  </head>
  <body>
    <div id="toast">‚úÖ Opera√ß√£o realizada!</div>

    <header class="app-header">
      <div>
        <h1 style="margin: 0; font-size: 18px">
          PONTO PRO <small style="font-size: 10px; opacity: 0.5">v5.1</small>
        </h1>
        <input
          type="date"
          id="inputDataFiltro"
          onchange="atualizarDataFiltro()"
          style="
            border: none;
            background: none;
            font-size: 12px;
            color: var(--primary);
            font-weight: bold;
          "
        />
      </div>
      <button
        onclick="toggleDarkMode()"
        style="background: none; border: none; font-size: 20px"
      >
        üåì
      </button>
    </header>

    <div class="container">
      <main id="tab-registros" class="tab-pane active">
        <div class="dash-grid">
          <div
            class="dash-card"
            id="card-total"
            onclick="setFiltroStatus('TODOS')"
          >
            <span id="dashTotal">0</span>Total
          </div>
          <div
            class="dash-card"
            id="card-ok"
            style="border-color: var(--success)"
            onclick="setFiltroStatus('FECHADO')"
          >
            <span id="dashPresentes">0</span>OK
          </div>
          <div
            class="dash-card"
            id="card-pendente"
            style="border-color: var(--warning)"
            onclick="setFiltroStatus('PENDENTE')"
          >
            <span id="dashPendentes">0</span>Abertos
          </div>
          <div
            class="dash-card"
            id="card-vazio"
            onclick="setFiltroStatus('VAZIO')"
          >
            <span id="dashVazios">0</span>Faltas
          </div>
        </div>
        <input
          type="text"
          id="searchInput"
          class="search-input"
          placeholder="üîç Buscar nome, placa ou tipo..."
          oninput="renderizarCards()"
        />
        <div id="cardsContainer"></div>
      </main>

      <section id="tab-local" class="tab-pane">
        <h3 style="display: flex; align-items: center; gap: 10px">
          üìç Local / P√°tio
          <span
            id="countLocal"
            style="
              background: var(--success);
              color: white;
              padding: 2px 8px;
              border-radius: 10px;
              font-size: 12px;
            "
            >0</span
          >
        </h3>
        <div
          id="presencePanel"
          style="
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
          "
        ></div>
      </section>

      <section id="tab-tools" class="tab-pane">
        <h3>‚öôÔ∏è Ferramentas v5.1</h3>
        <div style="display: grid; gap: 10px">
          <button
            class="btn"
            style="background: #6c5ce7; color: white"
            onclick="validarGestor(abrirGerenciadorSenha)"
          >
            üîë Gerenciar Senha Admin
          </button>
          <button
            class="btn"
            style="background: #2d3436; color: white"
            onclick="abrirAuditoria()"
          >
            üìú Ver Logs de Auditoria
          </button>
          <button
            class="btn"
            style="background: #e67e22; color: white"
            onclick="validarGestor(() => document.getElementById('inputImportar').click())"
          >
            üì• Importar JSON
          </button>
          <input
            type="file"
            id="inputImportar"
            style="display: none"
            accept=".json"
            onchange="importarJSON(event)"
          />
          <button
            class="btn"
            style="background: #00b894; color: white"
            onclick="exportarExcel()"
          >
            üìä Exportar Excel
          </button>
          <button
            class="btn"
            style="background: #d63031; color: white"
            onclick="exportarPDFGeral()"
          >
            üìï PDF Geral
          </button>
          <button
            class="btn"
            style="background: #6c757d; color: white"
            onclick="validarGestor(fazerBackup)"
          >
            üíæ Backup Total
          </button>
        </div>
        <div
          id="auditoriaBox"
          style="
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 15px;
            border: 1px solid var(--border);
          "
        >
          <div id="logList"></div>
        </div>
      </section>
    </div>

    <nav class="bottom-nav">
      <button class="nav-btn active" onclick="switchTab('tab-registros', this)">
        üìã Ponto
      </button>
      <button class="nav-btn-main" onclick="abrirModalCadastro()">Ôºã</button>
      <button class="nav-btn" onclick="switchTab('tab-local', this)">
        üìç Local
      </button>
      <button class="nav-btn" onclick="switchTab('tab-tools', this)">
        ‚öôÔ∏è Mais
      </button>
    </nav>

    <div id="modalCadastro">
      <div class="modal-box">
        <h3 id="tituloCrud">Cadastro</h3>
        <input type="hidden" id="editFuncId" />
        <select id="formVinculo" class="search-input">
          <option value="COLABORADOR">COLABORADOR (PROFESSOR)</option>
          <option value="VISITANTE">VISITANTE</option>
          <option value="TERCEIRIZADO">TERCEIRIZADO</option>
        </select>
        <input
          type="text"
          id="formNome"
          class="search-input"
          placeholder="Nome Completo"
        />
        <input
          type="text"
          id="formTelefone"
          class="search-input"
          placeholder="WhatsApp (DDD) 90000-0000"
          oninput="aplicarMascaraTelefone(this)"
        />
        <input
          type="text"
          id="formFuncao"
          class="search-input"
          placeholder="Cargo / Setor"
        />
        <input
          type="text"
          id="formPlaca"
          class="search-input"
          placeholder="Placa"
          oninput="aplicarMascaraPlaca(this)"
          maxlength="8"
        />
        <input
          type="text"
          id="formVeiculoModelo"
          class="search-input"
          placeholder="Modelo do Ve√≠culo"
        />
        <label
          style="font-size: 10px; font-weight: bold; color: var(--alert-color)"
          >‚ö†Ô∏è SELECIONE OU ESCREVA O ALERTA</label
        >
        <input
          list="listaAlertas"
          id="formAlerta"
          class="search-input"
          placeholder="Nenhum alerta ativo"
        />
        <datalist id="listaAlertas">
          <option value="POL√çCIA MILITAR">üöì POL√çCIA MILITAR</option>
          <option value="FAROL LIGADO">üí° FAROL LIGADO</option>
          <option value="OBSTRU√á√ÉO DE PASSAGEM">
            üö´ OBSTRU√á√ÉO DE PASSAGEM
          </option>
          <option value="AGENTE DE INCLUS√ÉO SOCIAL">
            ü§ù AGENTE DE INCLUS√ÉO SOCIAL
          </option>
          <option value="SUPERVISOR JUMPER">‚ö° SUPERVISOR JUMPER</option>
          <option value="SUPERVISOR EMPRESA DE LIMPEZA">
            üßπ SUPERVISOR EMPRESA DE LIMPEZA
          </option>
        </datalist>
        <div style="display: flex; gap: 10px">
          <button class="btn" onclick="fecharModalCadastro()">Cancelar</button>
          <button
            class="btn"
            style="background: var(--primary); color: white"
            onclick="processarFuncionario()"
          >
            Salvar
          </button>
        </div>
      </div>
    </div>

    <div id="modalSenha">
      <div class="modal-box">
        <h3>Alterar Senha Admin</h3>
        <input
          type="password"
          id="inputNovaSenha"
          class="search-input"
          placeholder="Nova Senha"
        />
        <div style="display: flex; gap: 10px">
          <button
            class="btn"
            onclick="document.getElementById('modalSenha').style.display='none'"
          >
            Sair
          </button>
          <button
            class="btn"
            style="background: var(--success); color: white"
            onclick="salvarNovaSenha()"
          >
            Salvar
          </button>
        </div>
      </div>
    </div>

    <div id="pontoEditModal">
      <div class="modal-box">
        <h3 id="modalFuncionarioNome">Ajustar Ponto</h3>
        <input
          type="text"
          id="modalMarcacoes"
          class="search-input"
          oninput="aplicarMascaraPonto(this)"
        />
        <input type="hidden" id="modalFuncionarioId" />
        <div style="display: flex; gap: 10px">
          <button class="btn" onclick="closePontoEditModal()">Sair</button>
          <button
            class="btn"
            style="background: var(--success); color: white"
            onclick="savePontoEditModal()"
          >
            Confirmar
          </button>
        </div>
      </div>
    </div>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBfcH5K-9sz7WQIZrt7Cb4U39r7vuU6E7Q",
        authDomain: "espelhodepontoetecvilaformosa.firebaseapp.com",
        databaseURL:
          "https://espelhodepontoetecvilaformosa-default-rtdb.firebaseio.com",
        projectId: "espelhodepontoetecvilaformosa",
        storageBucket: "espelhodepontoetecvilaformosa.firebasestorage.app",
        messagingSenderId: "1076635740136",
        appId: "1:1076635740136:web:567dbfeb482017d532721d",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      let dadosFuncionarios = [];
      let logsAuditoria = [];
      let dataSelecionadaISO = new Date().toISOString().slice(0, 10);
      let filtroStatusDashboard = "TODOS"; // Vari√°vel para controlar o filtro do dashboard
      const PASS_KEY = "ponto_admin_pass";

      // Monitoramento Central do Firebase
      db.ref("funcionarios").on("value", (s) => {
        const val = s.val();
        dadosFuncionarios = val
          ? Object.keys(val).map((k) => ({ ...val[k], id: k }))
          : [];
        renderizarCards();
        renderizarPainelPresenca();
      });

      db.ref("auditoria")
        .limitToLast(30)
        .on("value", (s) => {
          logsAuditoria = s.val() ? Object.values(s.val()).reverse() : [];
          renderizarLogs();
        });

      function renderizarLogs() {
        const list = document.getElementById("logList");
        list.innerHTML = logsAuditoria
          .map(
            (l) => `<div class="log-item"><b>[${l.data}]</b> ${l.acao}</div>`
          )
          .join("");
      }

      function registrarLog(msg) {
        const data = new Date().toLocaleString("pt-BR");
        db.ref("auditoria").push({ data, acao: msg });
      }

      function showToast(msg) {
        const t = document.getElementById("toast");
        t.innerText = msg;
        t.className = "show";
        setTimeout(() => {
          t.className = t.className.replace("show", "");
        }, 3000);
      }

      function aplicarMascaraTelefone(i) {
        let v = i.value.replace(/\D/g, "");
        if (v.length > 2) v = "(" + v.substring(0, 2) + ") " + v.substring(2);
        if (v.length > 9) v = v.substring(0, 10) + "-" + v.substring(10);
        i.value = v;
      }

      function aplicarMascaraPlaca(i) {
        let v = i.value.toUpperCase().replace(/[^A-Z0-9]/g, "");
        if (v.length === 7 && /^[A-Z]{3}[0-9]{4}$/.test(v)) {
          v = v.substring(0, 3) + "-" + v.substring(3, 7);
        }
        i.value = v;
      }

      function aplicarMascaraPonto(i) {
        let v = i.value.replace(/\D/g, "");
        let f = "";
        for (let j = 0; j < v.length; j++) {
          if (j > 0 && j % 6 === 0) f += ", ";
          else if (j > 0 && j % 2 === 0 && j % 6 !== 0) f += ":";
          f += v[j];
        }
        i.value = f;
      }

      function notificarGrupo(id) {
        const f = dadosFuncionarios.find((x) => x.id === id);
        const texto = `*OCORR√äNCIA DE P√ÅTIO* üö®\n\n*NOME:* ${
          f.nome
        }\n*PLACA:* ${f.placa || "---"}\n*OCORR√äNCIA:* ${
          f.alertaAtivo
        }\n\n_PONTO PRO v5.1 - SISTEMA CRIADO E DESENVOLVIDO POR RODRIGO DEV._`;
        const el = document.createElement("textarea");
        el.value = texto;
        document.body.appendChild(el);
        el.select();
        document.execCommand("copy");
        document.body.removeChild(el);
        showToast("‚úÖ Copiado! Abrindo WhatsApp...");
        setTimeout(() => {
          window.location.href = `whatsapp://send?text=${encodeURIComponent(
            texto
          )}`;
        }, 600);
      }

      function enviarZapIndividual(id) {
        const f = dadosFuncionarios.find((x) => x.id === id);
        const msg = f.alertaAtivo
          ? `Ol√° ${f.nome}, o seu ve√≠culo (${f.placa || ""}) est√° com: *${
              f.alertaAtivo
            }*.`
          : `Ol√° ${f.nome}, tudo bem?`;
        window.open(
          `https://api.whatsapp.com/send?phone=55${f.telefone.replace(
            /\D/g,
            ""
          )}&text=${encodeURIComponent(msg)}`,
          "_blank"
        );
      }

      function baterPonto(id) {
        const agora = new Date().toLocaleTimeString("pt-BR", {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
        const ref = db.ref(
          `funcionarios/${id}/historico/${dataSelecionadaISO}/marcacoes`
        );
        ref.get().then((s) => {
          let m = s.val() || [];
          m.push(agora);
          ref.set(m).then(() => {
            showToast("‚è∞ Ponto registrado com sucesso!");
          });
        });
      }

      // Fun√ß√£o para definir o filtro baseado no clique do Dashboard
      function setFiltroStatus(status) {
        filtroStatusDashboard = status;

        // Remove destaque visual de todos e adiciona no clicado
        document
          .querySelectorAll(".dash-card")
          .forEach((c) => c.classList.remove("active-filter"));
        if (status === "TODOS")
          document.getElementById("card-total").classList.add("active-filter");
        if (status === "FECHADO")
          document.getElementById("card-ok").classList.add("active-filter");
        if (status === "PENDENTE")
          document
            .getElementById("card-pendente")
            .classList.add("active-filter");
        if (status === "VAZIO")
          document.getElementById("card-vazio").classList.add("active-filter");

        renderizarCards();
      }

      function renderizarCards() {
        const container = document.getElementById("cardsContainer");
        const busca = document
          .getElementById("searchInput")
          .value.toUpperCase();
        container.innerHTML = "";

        dadosFuncionarios
          .filter((f) => {
            const m = f.historico?.[dataSelecionadaISO]?.marcacoes || [];
            const statusAtual =
              m.length === 0
                ? "VAZIO"
                : m.length % 2 !== 0
                ? "PENDENTE"
                : "FECHADO";

            // Filtro de Busca (Texto)
            const bateBusca = (f.nome + (f.placa || ""))
              .toUpperCase()
              .includes(busca);

            // Filtro de Dashboard (Status)
            const bateStatus =
              filtroStatusDashboard === "TODOS" ||
              statusAtual === filtroStatusDashboard;

            return bateBusca && bateStatus;
          })
          .forEach((f) => {
            const m = f.historico?.[dataSelecionadaISO]?.marcacoes || [];
            const status =
              m.length === 0
                ? "VAZIO"
                : m.length % 2 !== 0
                ? "PENDENTE"
                : "FECHADO";

            container.innerHTML += `
            <div class="emp-card ${
              f.alertaAtivo ? "has-alert" : ""
            }" onclick="this.classList.toggle('open')">
              <span class="badge-vinculo" style="background:#636e72">${
                f.vinculo || "COLABORADOR"
              }</span>
              <div style="display:flex; justify-content:space-between; align-items:center">
                <div>
                   <b style="font-size:15px">${f.nome}</b> 
                   <span style="color:var(--primary); font-weight:bold; margin-left:5px">[${
                     f.placa || "S/P"
                   }]</span>
                   <br><small>${f.funcao}</small>
                </div>
                <span class="status-pill" style="background:${
                  status === "FECHADO"
                    ? "var(--success)"
                    : status === "PENDENTE"
                    ? "var(--warning)"
                    : "var(--text-sub)"
                }">${status}</span>
              </div>
              <div class="marcacoes-row" style="margin:10px 0">${
                m.map((h) => `<span class="time-tag">${h}</span>`).join("") ||
                "---"
              }</div>
              <div style="display:flex; gap:8px">
                ${
                  f.telefone
                    ? `<button class="btn-whatsapp" onclick="event.stopPropagation(); enviarZapIndividual('${f.id}')">üì± Zap</button>`
                    : ""
                }
                ${
                  f.alertaAtivo
                    ? `<button class="btn-group-alert" onclick="event.stopPropagation(); notificarGrupo('${f.id}')">üö® Grupo</button>`
                    : ""
                }
              </div>
              <div class="smart-details">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px">
                  <button class="btn" style="background:#3498db; color:white" onclick="event.stopPropagation(); exportarPDFIndividual('${
                    f.id
                  }')">üìÑ PDF Ind.</button>
                  <button class="btn" style="background:#007bff; color:white" onclick="event.stopPropagation(); iniciarEdicaoPonto('${
                    f.id
                  }')">‚úèÔ∏è Ponto</button>
                  <button class="btn" style="background:var(--text-sub); color:white" onclick="event.stopPropagation(); iniciarEdicaoCadastro('${
                    f.id
                  }')">‚öôÔ∏è Dados</button>
                  <button class="btn" style="background:var(--danger); color:white" onclick="event.stopPropagation(); excluirFuncionario('${
                    f.id
                  }')">üóëÔ∏è Excluir</button>
                </div>
              </div>
              <button class="btn" style="background:var(--primary); color:white; width:100%; margin-top:10px; padding:12px" onclick="event.stopPropagation(); baterPonto('${
                f.id
              }')">REGISTRAR AGORA</button>
            </div>`;
          });
        atualizarDashboard();
      }

      function renderizarPainelPresenca() {
        const p = document.getElementById("presencePanel");
        const c = document.getElementById("countLocal");
        p.innerHTML = "";
        let count = 0;
        dadosFuncionarios.forEach((f) => {
          const m = f.historico?.[dataSelecionadaISO]?.marcacoes || [];
          if (m.length % 2 !== 0) {
            count++;
            p.innerHTML += `
              <div class="local-card">
                <b>${f.nome || "DESCONHECIDO"}</b><br>
                <small style="color:var(--primary)">[${
                  f.placa || "S/P"
                }]</small><br>
                <span class="local-timer" data-inicio="${
                  m[m.length - 1]
                }">...</span>
              </div>`;
          }
        });
        c.innerText = count;
      }

      function atualizarCronometros() {
        document.querySelectorAll(".local-timer").forEach((t) => {
          const [h, m, s] = t.dataset.inicio.split(":").map(Number);
          const inicio = new Date();
          inicio.setHours(h, m, s);
          let diff = Math.floor((new Date() - inicio) / 1000);
          if (diff < 0) diff = 0;
          const hrs = String(Math.floor(diff / 3600)).padStart(2, "0");
          const min = String(Math.floor((diff % 3600) / 60)).padStart(2, "0");
          const seg = String(diff % 60).padStart(2, "0");
          t.innerText = `${hrs}:${min}:${seg}`;
        });
      }

      function processarFuncionario() {
        const id =
          document.getElementById("editFuncId").value || Date.now().toString();
        const fExistente = dadosFuncionarios.find((x) => x.id === id);
        const d = {
          nome: document.getElementById("formNome").value.toUpperCase(),
          vinculo: document.getElementById("formVinculo").value,
          telefone: document.getElementById("formTelefone").value,
          funcao: document.getElementById("formFuncao").value.toUpperCase(),
          placa: document.getElementById("formPlaca").value.toUpperCase(),
          veiculoModelo: document
            .getElementById("formVeiculoModelo")
            .value.toUpperCase(),
          alertaAtivo: document
            .getElementById("formAlerta")
            .value.toUpperCase(),
          historico: fExistente ? fExistente.historico || {} : {},
        };
        db.ref("funcionarios/" + id)
          .set(d)
          .then(() => {
            registrarLog(`Adm editou: ${d.nome}`);
            fecharModalCadastro();
            showToast("‚úÖ Dados salvos!");
          });
      }

      function exportarExcel() {
        let csv = "\ufeffNome;Placa;Batidas\n";
        dadosFuncionarios.forEach(
          (f) =>
            (csv += `${f.nome};${f.placa || ""};${(
              f.historico?.[dataSelecionadaISO]?.marcacoes || []
            ).join(" | ")}\n`)
        );
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
        a.download = `ponto.csv`;
        a.click();
      }

      function exportarPDFGeral() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF("l");
        doc.text(`Relat√≥rio - ${dataSelecionadaISO}`, 14, 15);
        const rows = dadosFuncionarios.map((f) => [
          f.nome,
          f.placa || "-",
          (f.historico?.[dataSelecionadaISO]?.marcacoes || []).join(" | "),
        ]);
        doc.autoTable({
          head: [["Nome", "Placa", "Batidas"]],
          body: rows,
          startY: 20,
        });
        doc.save(`Ponto_Geral.pdf`);
      }

      function exportarPDFIndividual(id) {
        const f = dadosFuncionarios.find((x) => x.id === id);
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text(`Espelho de Ponto: ${f.nome}`, 14, 15);
        const hist = f.historico || {};
        const rows = Object.keys(hist)
          .sort()
          .reverse()
          .map((data) => [
            data.split("-").reverse().join("/"),
            hist[data].marcacoes.join(" | "),
          ]);
        doc.autoTable({ head: [["Data", "Batidas"]], body: rows, startY: 30 });
        doc.save(`Ponto_${f.nome}.pdf`);
      }

      function excluirFuncionario(id) {
        if (confirm("Excluir registro?")) {
          db.ref("funcionarios/" + id)
            .remove()
            .then(() => registrarLog("Adm removeu registro"));
        }
      }

      function validarGestor(cb) {
        const s = localStorage.getItem(PASS_KEY) || "1234";
        const t = prompt("Senha:");
        if (t === s) cb();
        else if (t !== null) alert("Erro!");
      }

      function salvarNovaSenha() {
        const n = document.getElementById("inputNovaSenha").value;
        if (n) {
          localStorage.setItem(PASS_KEY, n);
          alert("Salvo!");
          document.getElementById("modalSenha").style.display = "none";
        }
      }

      function fazerBackup() {
        const b = new Blob(
          [
            JSON.stringify({
              funcionarios: dadosFuncionarios,
              auditoria: logsAuditoria,
            }),
          ],
          { type: "application/json" }
        );
        const a = document.createElement("a");
        a.href = URL.createObjectURL(b);
        a.download = `backup_v5_1.json`;
        a.click();
      }

      function importarJSON(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const json = JSON.parse(e.target.result);
            if (confirm("Importar?")) db.ref("/").update(json);
          } catch (err) {
            alert("Erro!");
          }
        };
        reader.readAsText(file);
      }

      function switchTab(id, btn) {
        document
          .querySelectorAll(".tab-pane")
          .forEach((p) => p.classList.remove("active"));
        document
          .querySelectorAll(".nav-btn")
          .forEach((b) => b.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        btn.classList.add("active");
      }

      function toggleDarkMode() {
        document.body.classList.toggle("dark-mode");
      }

      function atualizarDataFiltro() {
        dataSelecionadaISO = document.getElementById("inputDataFiltro").value;
        renderizarCards();
        renderizarPainelPresenca();
      }

      function atualizarDashboard() {
        let ok = 0,
          pen = 0,
          vaz = 0;
        dadosFuncionarios.forEach((f) => {
          const m = f.historico?.[dataSelecionadaISO]?.marcacoes || [];
          if (m.length === 0) vaz++;
          else if (m.length % 2 !== 0) pen++;
          else ok++;
        });
        document.getElementById("dashTotal").innerText =
          dadosFuncionarios.length;
        document.getElementById("dashPresentes").innerText = ok;
        document.getElementById("dashPendentes").innerText = pen;
        document.getElementById("dashVazios").innerText = vaz;
      }

      function abrirGerenciadorSenha() {
        document.getElementById("modalSenha").style.display = "flex";
      }
      function abrirAuditoria() {
        document.getElementById("auditoriaBox").style.display = "block";
      }
      function fecharModalCadastro() {
        document.getElementById("modalCadastro").style.display = "none";
      }
      function closePontoEditModal() {
        document.getElementById("pontoEditModal").style.display = "none";
      }

      function abrirModalCadastro() {
        document.getElementById("editFuncId").value = "";
        document.getElementById("formNome").value = "";
        document.getElementById("formTelefone").value = "";
        document.getElementById("formFuncao").value = "";
        document.getElementById("formPlaca").value = "";
        document.getElementById("formVeiculoModelo").value = "";
        document.getElementById("formAlerta").value = "";
        document.getElementById("modalCadastro").style.display = "flex";
      }

      function iniciarEdicaoPonto(id) {
        const f = dadosFuncionarios.find((x) => x.id === id);
        document.getElementById("modalFuncionarioId").value = id;
        document.getElementById("modalFuncionarioNome").innerText = f.nome;
        document.getElementById("modalMarcacoes").value = (
          f.historico?.[dataSelecionadaISO]?.marcacoes || []
        ).join(", ");
        document.getElementById("pontoEditModal").style.display = "flex";
      }

      function savePontoEditModal() {
        const id = document.getElementById("modalFuncionarioId").value;
        const m = document
          .getElementById("modalMarcacoes")
          .value.split(",")
          .map((t) => t.trim())
          .filter((t) => t);
        db.ref(`funcionarios/${id}/historico/${dataSelecionadaISO}`)
          .update({ marcacoes: m })
          .then(() => closePontoEditModal());
      }

      function iniciarEdicaoCadastro(id) {
        const f = dadosFuncionarios.find((x) => x.id === id);
        document.getElementById("editFuncId").value = f.id;
        document.getElementById("formNome").value = f.nome;
        document.getElementById("formTelefone").value = f.telefone || "";
        document.getElementById("formFuncao").value = f.funcao || "";
        document.getElementById("formPlaca").value = f.placa || "";
        document.getElementById("formVeiculoModelo").value =
          f.veiculoModelo || "";
        document.getElementById("formAlerta").value = f.alertaAtivo || "";
        document.getElementById("modalCadastro").style.display = "flex";
      }

      setInterval(atualizarCronometros, 1000);
      document.getElementById("inputDataFiltro").value = dataSelecionadaISO;

      // Inicia com o filtro TOTAL selecionado visualmente
      document.getElementById("card-total").classList.add("active-filter");
    </script>
  </body>
</html>
